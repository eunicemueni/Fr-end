<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kairah Studio — AI Video Atelier</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg,#0f0b11,#1a1424); color: #fff; }
    .btn { background-color: #D4AF37; color: #000; padding: .6rem 1.1rem; border-radius: .6rem; font-weight: 700; display:inline-flex; align-items:center; gap:.5rem; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.04); padding: 1rem; border-radius: .8rem; }
    .muted { color: rgba(255,255,255,0.75); }
    .video-preview { max-width:100%; border-radius:.6rem; background:#000; min-height:160px; display:flex; align-items:center; justify-content:center; }
    .hidden { display:none; }
    a { text-decoration: none; }
    .small { font-size: .9rem; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top nav -->
  <nav class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#3D2C41] to-[#D4AF37] flex items-center justify-center font-bold text-black">K</div>
      <div>
        <div class="text-xl font-bold text-[#D4AF37]">Kairah Studio</div>
        <div class="text-xs muted">AI Video Atelier</div>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <div id="user-info" class="hidden items-center gap-3">
        <div id="user-email" class="muted text-sm"></div>
        <button id="signout-btn" class="btn">Sign out</button>
      </div>
      <div id="auth-actions">
        <button id="open-signin" class="btn">Sign in</button>
      </div>
    </div>
  </nav>

  <!-- Main container -->
  <main class="max-w-7xl mx-auto px-6 pb-20">

    <!-- Hero + CTA -->
    <section class="text-center py-12">
      <h1 class="text-5xl md:text-6xl font-extrabold text-[#D4AF37]">Kairah Studio — AI Video Atelier</h1>
      <p class="mt-4 text-lg muted max-w-3xl mx-auto">
        Forge cinematic worlds from simple prompts or photos. Text-to-video, photo-to-video, face swap and voice cloning —
        crafted for creators who want cinematic, viral-ready content fast.
      </p>

      <div class="mt-6 flex items-center justify-center gap-4">
        <a href="#create" class="btn">Start Creating</a>
        <a href="#pricing" class="btn">Plans</a>
      </div>

      <div class="mt-4 text-sm muted max-w-3xl mx-auto">
        <strong>Note:</strong> Some sites call full, unrestricted tools "godmode" — slang for "all-powerful access". We've removed that term here and use clear plan names and limits instead.
      </div>
    </section>

    <!-- Create tool -->
    <section id="create" class="grid md:grid-cols-3 gap-8">
      <!-- Left: controls -->
      <div class="md:col-span-1 card">
        <h2 class="text-2xl font-bold text-[#D4AF37]">Create Video</h2>
        <p class="muted text-sm mt-1">Text-to-Video / Photo-to-Video / Face Swap / Infuser</p>

        <label class="block mt-4 text-sm">Choose model / pipeline</label>
        <select id="model-select" class="w-full mt-1 p-2 rounded bg-black/30"></select>

        <label class="block mt-4 text-sm">Prompt</label>
        <textarea id="prompt" rows="4" class="w-full mt-1 p-2 rounded bg-black/30" placeholder="Write cinematic prompt..."></textarea>

        <label class="block mt-4 text-sm">Upload photos (optional)</label>
        <input id="photos" type="file" accept="image/*" multiple class="mt-2 w-full text-sm"/>

        <div class="flex gap-2 mt-4">
          <label class="text-sm self-center">Length</label>
          <select id="length" class="p-2 rounded bg-black/30">
            <option value="6">6s</option>
            <option value="15">15s</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
          </select>
          <label class="text-sm self-center">Quality</label>
          <select id="quality" class="p-2 rounded bg-black/30">
            <option value="hd">HD</option>
            <option value="fhd">FHD</option>
            <option value="4k">4K</option>
          </select>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="generate-btn" class="btn flex-1">Generate</button>
          <button id="regenerate-btn" class="btn hidden">Re-gen</button>
        </div>

        <div class="mt-3 text-xs muted">
          <strong>Free users:</strong> 1 download per email. Paid users have full access. Sign in to generate.
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-semibold">Available API models</h3>
          <ul id="models-list" class="mt-2 text-xs muted list-disc pl-4" style="line-height:1.6"></ul>
        </div>
      </div>

      <!-- Middle: preview -->
      <div class="md:col-span-2 card">
        <h3 class="text-lg font-bold">Preview</h3>

        <div id="video-container" class="mt-4 video-preview">
          <div id="preview-placeholder" class="muted">No preview yet — generate a video to preview here.</div>
        </div>

        <div id="generation-status" class="mt-4 muted text-sm"></div>

        <div class="mt-4 flex gap-3">
          <button id="download-btn" class="btn hidden">Download</button>
          <button id="save-btn" class="btn hidden">Save to Dashboard</button>
          <button id="open-dashboard" class="btn hidden">Open Dashboard</button>
        </div>

        <div id="download-info" class="mt-3 text-xs muted"></div>
      </div>
    </section>

    <!-- Pricing & Plans -->
    <section id="pricing" class="mt-12 card">
      <h2 class="text-2xl font-bold text-[#D4AF37]">Plans</h2>
      <p class="muted text-sm mt-1">Early bird discounts for the first 100 users.</p>

      <div class="mt-6 grid md:grid-cols-4 gap-4">
        <!-- Entry -->
        <div class="p-4 border rounded">
          <h3 class="font-bold">Entry</h3>
          <p class="text-sm muted">$19 — Starter access</p>
          <div class="mt-3 flex flex-col gap-2">
            <a class="btn small" href="https://www.paypal.com/ncp/payment/2X583XDXBYUPN" target="_blank">PayPal — Entry</a>
            <a class="btn small" href="https://paystack.shop/pay/ge2324r8fu" target="_blank">Paystack — Entry</a>
            <div class="mt-2 small muted">M-Pesa payments: <strong>0113554446</strong></div>
          </div>
        </div>

        <!-- Pro -->
        <div class="p-4 border rounded">
          <h3 class="font-bold">Pro</h3>
          <p class="text-sm muted">$49 — Monthly pro tools</p>
          <div class="mt-3 flex flex-col gap-2">
            <a class="btn small" href="https://www.paypal.com/ncp/payment/DVSZY7GB2QCYW" target="_blank">PayPal — Pro</a>
            <a class="btn small" href="https://paystack.shop/pay/uli4nrj8xq" target="_blank">Paystack — Pro</a>
          </div>
        </div>

        <!-- Diamond -->
        <div class="p-4 border rounded">
          <h3 class="font-bold">Diamond</h3>
          <p class="text-sm muted">$449 — Power user</p>
          <div class="mt-3 flex flex-col gap-2">
            <a class="btn small" href="https://www.paypal.com/ncp/payment/S77ESJWSU79JU" target="_blank">PayPal — Diamond</a>
            <a class="btn small" href="https://paystack.shop/pay/4u6jdu7eft" target="_blank">Paystack — Diamond</a>
          </div>
        </div>

        <!-- Lifetime -->
        <div class="p-4 border rounded">
          <h3 class="font-bold">Lifetime</h3>
          <p class="text-sm muted">$1,400 — Full access forever</p>
          <div class="mt-3 flex flex-col gap-2">
            <a class="btn small" href="https://www.paypal.com/ncp/payment/K4Y9SVNW76XYU" target="_blank">PayPal — Lifetime</a>
            <a class="btn small" href="https://paystack.shop/pay/-cdm6oobkz" target="_blank">Paystack — Lifetime</a>
          </div>
        </div>
      </div>

      <div class="mt-4 small muted">
        <strong>M-Pesa Payment Info:</strong> Send to <strong>0113554446</strong> — include your email & chosen plan in the message. We will verify and manually assign plan access (or integrate automated M-Pesa later).
      </div>
    </section>

    <!-- FAQ -->
    <section class="mt-8 card">
      <h3 class="text-lg font-bold">FAQ</h3>
      <div class="mt-4 text-sm muted">
        <p><strong>What did "godmode" mean?</strong> — It's slang meaning "unlimited, all-powerful access." That term can sound confusing or extreme; we've replaced it with clear plan names and descriptions.</p>
        <p><strong>Free users:</strong> 1 download per email. Backend enforces limits.</p>
        <p><strong>APIs used:</strong> /api/generate-video, /api/upload, /api/request-download, /api/job-status/:id, /api/user/videos.</p>
      </div>
    </section>

    <footer class="mt-8 text-center muted text-sm">
      © Kairah Studio — crafted with care.
    </footer>
  </main>

  <!-- Sign-in modal (simple) -->
  <div id="signin-modal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
    <div class="bg-[#0d0b0e] p-6 rounded-lg w-full max-w-md">
      <h3 class="text-xl font-bold text-[#D4AF37]">Sign in / Sign up</h3>
      <div class="mt-4">
        <input id="email-input" type="email" placeholder="Email" class="w-full p-2 rounded mt-2 bg-black/20"/>
        <input id="pass-input" type="password" placeholder="Password" class="w-full p-2 rounded mt-2 bg-black/20"/>
        <div class="flex gap-2 mt-3">
          <button id="email-signin" class="btn flex-1">Sign In</button>
          <button id="email-signup" class="btn flex-1">Sign Up</button>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="google-signin" class="btn flex-1">Sign in with Google</button>
          <button id="close-modal" class="btn flex-1">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase & Client JS -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>

  <script>
    /*************************************************************************
     * CONFIG - already populated with your values
     *
     * FIREBASE_CONFIG: contains the apiKey you provided along with other fields.
     * BACKEND_BASE_URL: your Render backend.
     *
     * Make sure your backend verifies Firebase ID tokens and enforces
     * download limits & quotas per email / user.
     *************************************************************************/

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAGlNOCAwsgeDnSJtBux2uIMuP0p_jBJns",
      authDomain: "kairah-studio.firebaseapp.com",
      projectId: "kairah-studio",
      storageBucket: "kairah-studio.firebasestorage.app",
      messagingSenderId: "145122424961",
      appId: "1:145122424961:web:5f5d9cc0f36d8f30503580",
      measurementId: "G-MGN2176Y5Q"
    };
    const BACKEND_BASE_URL = "https://k-stu-3y.onrender.com";

    // Models/pipelines the UI exposes (your backend should accept these ids)
    const AVAILABLE_MODELS = [
      { id: 'text_to_video', name: 'Text → Video (Run Diffusion)' },
      { id: 'photo_to_video', name: 'Photo → Video (Infuser)' },
      { id: 'run_diffusion', name: 'Run Diffusion (Cinematic)' },
      { id: 'face_swap', name: 'Face Swap' },
      { id: 'infuser', name: 'Infuser (photo blending)' },
      { id: 'voice_clone', name: 'Voice Clone' },
      { id: 'upscale', name: 'Upscale / Enhance' },
      { id: 'edit', name: 'Edit / Inpaint' },
      { id: 'preview', name: 'Preview / Low-res' }
    ];

    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();

    // UI refs
    const signInModal = document.getElementById('signin-modal');
    const openSignin = document.getElementById('open-signin');
    const closeModal = document.getElementById('close-modal');
    const emailSigninBtn = document.getElementById('email-signin');
    const emailSignupBtn = document.getElementById('email-signup');
    const googleSigninBtn = document.getElementById('google-signin');
    const signoutBtn = document.getElementById('signout-btn');
    const userInfoWrap = document.getElementById('user-info');
    const userEmailEl = document.getElementById('user-email');
    const authActions = document.getElementById('auth-actions');

    const modelSelect = document.getElementById('model-select');
    const modelsList = document.getElementById('models-list');
    const promptEl = document.getElementById('prompt');
    const photosEl = document.getElementById('photos');
    const generateBtn = document.getElementById('generate-btn');
    const regenerateBtn = document.getElementById('regenerate-btn');
    const videoContainer = document.getElementById('video-container');
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const generationStatus = document.getElementById('generation-status');
    const downloadBtn = document.getElementById('download-btn');
    const saveBtn = document.getElementById('save-btn');
    const openDashboardBtn = document.getElementById('open-dashboard');
    const downloadInfo = document.getElementById('download-info');

    // populate models UI
    AVAILABLE_MODELS.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id; opt.textContent = m.name;
      modelSelect.appendChild(opt);

      const li = document.createElement('li');
      li.textContent = m.id + ' — ' + m.name;
      modelsList.appendChild(li);
    });

    // auth modal handlers
    openSignin.addEventListener('click', () => signInModal.classList.remove('hidden'));
    closeModal.addEventListener('click', () => signInModal.classList.add('hidden'));

    emailSigninBtn.addEventListener('click', async () => {
      const email = document.getElementById('email-input').value;
      const pass = document.getElementById('pass-input').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        signInModal.classList.add('hidden');
      } catch (e) {
        alert('Sign in error: ' + e.message);
      }
    });

    emailSignupBtn.addEventListener('click', async () => {
      const email = document.getElementById('email-input').value;
      const pass = document.getElementById('pass-input').value;
      try {
        const userCred = await auth.createUserWithEmailAndPassword(email, pass);
        await userCred.user.sendEmailVerification();
        signInModal.classList.add('hidden');
        alert('Signed up — verification email sent.');
      } catch (e) {
        alert('Sign up error: ' + e.message);
      }
    });

    googleSigninBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
        signInModal.classList.add('hidden');
      } catch (e) {
        alert('Google sign in error: ' + e.message);
      }
    });

    signoutBtn.addEventListener('click', async () => {
      await auth.signOut();
    });

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userInfoWrap.classList.remove('hidden');
        authActions.classList.add('hidden');
        userEmailEl.textContent = user.email;
        openDashboardBtn.classList.remove('hidden');
      } else {
        userInfoWrap.classList.add('hidden');
        authActions.classList.remove('hidden');
        openDashboardBtn.classList.add('hidden');
      }
    });

    async function getIdToken() {
      const user = auth.currentUser;
      if (!user) return null;
      return await user.getIdToken(true);
    }

    async function uploadFiles(files) {
      if (!files || files.length === 0) return [];
      const token = await getIdToken();
      const form = new FormData();
      for (let i = 0; i < files.length; i++) form.append('files', files[i]);
      const res = await fetch(BACKEND_BASE_URL + '/api/upload', {
        method: 'POST',
        headers: token ? { 'Authorization': 'Bearer ' + token } : {},
        body: form
      });
      if (!res.ok) throw new Error('Upload failed: ' + await res.text());
      return await res.json();
    }

    // generation
    let lastGeneration = null;
    generateBtn.addEventListener('click', async () => {
      try {
        if (!auth.currentUser) {
          signInModal.classList.remove('hidden');
          return;
        }
        generateBtn.disabled = true;
        generationStatus.textContent = 'Preparing...';
        const model = modelSelect.value;
        const prompt = promptEl.value.trim();
        const length = document.getElementById('length').value;
        const quality = document.getElementById('quality').value;

        const files = photosEl.files;
        let uploaded = [];
        if (files && files.length > 0) {
          generationStatus.textContent = 'Uploading images...';
          const upData = await uploadFiles(files);
          uploaded = upData.files || [];
        }

        generationStatus.textContent = 'Requesting generation...';

        const token = await getIdToken();
        const payload = {
          model,
          prompt,
          options: { length, quality },
          files: uploaded.map(f=>f.id)
        };

        const res = await fetch(BACKEND_BASE_URL + '/api/generate-video', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? ('Bearer ' + token) : ''
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error('Generation request failed: ' + text);
        }

        const data = await res.json(); // { jobId, previewUrl? }
        lastGeneration = data;
        showPreviewFromData(data);
        generationStatus.textContent = 'Generation started. Job ID: ' + data.jobId;
        regenerateBtn.classList.remove('hidden');
        downloadBtn.classList.add('hidden');
        downloadInfo.textContent = '';
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        generateBtn.disabled = false;
      }
    });

    regenerateBtn.addEventListener('click', () => generateBtn.click());

    async function showPreviewFromData(data) {
      previewPlaceholder.remove();
      videoContainer.innerHTML = '';
      if (data.previewUrl) {
        const videoEl = document.createElement('video');
        videoEl.src = data.previewUrl;
        videoEl.controls = true;
        videoEl.className = 'video-preview';
        videoEl.style.minHeight = '240px';
        videoContainer.appendChild(videoEl);
        downloadBtn.classList.remove('hidden');
        saveBtn.classList.remove('hidden');
      } else {
        const spinner = document.createElement('div');
        spinner.textContent = 'Generating preview... (polling)';
        videoContainer.appendChild(spinner);
        pollJob(data.jobId);
      }
    }

    async function pollJob(jobId) {
      generationStatus.textContent = 'Polling job status...';
      let attempts = 0;
      const interval = setInterval(async () => {
        attempts++;
        if (attempts > 120) { clearInterval(interval); generationStatus.textContent = 'Timed out'; return; }
        try {
          const token = await getIdToken();
          const res = await fetch(BACKEND_BASE_URL + '/api/job-status/' + encodeURIComponent(jobId), {
            headers: { 'Authorization': token ? ('Bearer ' + token) : '' }
          });
          if (!res.ok) { console.warn('job poll failed', await res.text()); return; }
          const d = await res.json(); // { status, previewUrl?, resultUrl? }
          generationStatus.textContent = 'Job: ' + d.status;
          if (d.previewUrl) {
            clearInterval(interval);
            videoContainer.innerHTML = '';
            const videoEl = document.createElement('video');
            videoEl.src = d.previewUrl;
            videoEl.controls = true;
            videoEl.className = 'video-preview';
            videoEl.style.minHeight = '240px';
            videoContainer.appendChild(videoEl);
            downloadBtn.classList.remove('hidden');
            saveBtn.classList.remove('hidden');
            lastGeneration = d;
          }
          if (d.status === 'failed') {
            clearInterval(interval);
            generationStatus.textContent = 'Generation failed.';
          }
        } catch (err) {
          console.warn('poll error', err);
        }
      }, 3000);
    }

    downloadBtn.addEventListener('click', async () => {
      try {
        downloadBtn.disabled = true;
        generationStatus.textContent = 'Requesting download...';
        const token = await getIdToken();
        const res = await fetch(BACKEND_BASE_URL + '/api/request-download', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? ('Bearer ' + token) : ''
          },
          body: JSON.stringify({ jobId: lastGeneration.jobId || lastGeneration.id || lastGeneration.resultId })
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error('Download request failed: ' + text);
        }
        const d = await res.json(); // { downloadUrl, message, downloadsLeft }
        window.open(d.downloadUrl, '_blank');
        downloadInfo.textContent = d.message ? d.message : 'Download started.';
      } catch (err) {
        alert('Download failed: ' + err.message);
      } finally {
        downloadBtn.disabled = false;
      }
    });

    saveBtn.addEventListener('click', async () => {
      try {
        const token = await getIdToken();
        const res = await fetch(BACKEND_BASE_URL + '/api/user/videos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? ('Bearer ' + token) : ''
          },
          body: JSON.stringify({ job: lastGeneration })
        });
        if (!res.ok) throw new Error(await res.text());
        alert('Saved to your dashboard.');
      } catch (err) {
        alert('Save failed: ' + err.message);
      }
    });

    document.getElementById('free-cta').addEventListener('click', () => {
      if (!auth.currentUser) signInModal.classList.remove('hidden');
      else alert('You are signed in. Use the create form above.');
    });

    window.addEventListener('load', () => {
      if (!FIREBASE_CONFIG.apiKey || BACKEND_BASE_URL.includes('your-backend')) {
        console.warn('Please verify FIREBASE_CONFIG and BACKEND_BASE_URL are correct.');
      }
    });

  </script>
</body>
</html>
